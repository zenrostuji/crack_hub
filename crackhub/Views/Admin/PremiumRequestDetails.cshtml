@model crackhub.Models.Data.PremiumRegister
@{
    ViewData["Title"] = "Chi tiết yêu cầu Premium";
    Layout = "_AdminLayout";
}

<div class="admin-premium-request-details">
    <div class="admin-page-title-container mb-4">
        <h4 class="admin-page-title">
            <i class="fas fa-crown me-2"></i> Chi tiết yêu cầu Premium #@Model.Id
        </h4>
        <div class="admin-page-actions">
            <a href="@Url.Action("PremiumRequests", "Admin")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Request Information -->
        <div class="col-lg-8">
            <div class="admin-form-section mb-4">
                <h5><i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">Mã yêu cầu</label>
                            <div class="fw-bold">#@Model.Id</div>
                        </div>                        <div class="mb-3">
                            <label class="form-label text-muted">Gói Premium</label>
                            <div class="fw-bold">@(Model.Premium?.DurationInMonths ?? "Chưa xác định") (Gói #@Model.PackageId)</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Số tiền</label>
                            <div class="fw-bold text-success fs-5">@(Model.Premium?.Price.ToString("#,##0") ?? "0")₫</div>
                        </div>
                    </div>
                    <div class="col-md-6">                        <div class="mb-3">
                            <label class="form-label text-muted">Ngày gửi</label>
                            <div class="fw-bold">@Model.RegisterDate.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Trạng thái</label>                            <div>
                                @switch (Model.Status)
                                {
                                    case 2: // Pending
                                        <span class="badge bg-warning text-dark fs-6">
                                            <i class="fas fa-clock me-1"></i>Đang chờ xử lý
                                        </span>
                                        break;
                                    case 1: // Approved
                                        <span class="badge bg-success fs-6">
                                            <i class="fas fa-check me-1"></i>Đã duyệt
                                        </span>
                                        break;
                                    case 3: // Rejected
                                        <span class="badge bg-danger fs-6">
                                            <i class="fas fa-times me-1"></i>Từ chối
                                        </span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary fs-6">
                                            <i class="fas fa-question me-1"></i>Không xác định
                                        </span>
                                        break;
                                }
                            </div>
                        </div>                        @if (Model.ApprovalDate.HasValue)
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted">Ngày xử lý</label>
                                <div class="fw-bold">@Model.ApprovalDate.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        }
                    </div>
                </div>                @if (!string.IsNullOrEmpty(Model.UserComment))
                {
                    <div class="mb-3">
                        <label class="form-label text-muted">Ghi chú từ người dùng</label>
                        <div class="alert alert-info">
                            <i class="fas fa-comment me-2"></i>@Model.UserComment
                        </div>
                    </div>
                }
            </div>

            <!-- User Information -->
            <div class="admin-form-section mb-4">
                <h5><i class="fas fa-user me-2"></i>Thông tin người dùng</h5>
                <div class="d-flex align-items-start">
                    @if (!string.IsNullOrEmpty(Model.User?.AvatarUrl))
                    {
                        <img src="~/uploads/avatars/@Model.User.AvatarUrl" alt="Avatar" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    }
                    else
                    {
                        <div class="bg-secondary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="fas fa-user text-white fa-2x"></i>
                        </div>
                    }
                    <div class="flex-grow-1">
                        <h6 class="mb-1">@Model.User?.DisplayName</h6>
                        <p class="text-muted mb-1">@Model.User?.Email</p>
                        <p class="text-muted mb-1">Đăng ký: @Model.User?.CreatedAt.ToString("dd/MM/yyyy")</p>
                        @if (Model.User?.PremiumExpiryDate.HasValue == true)
                        {
                            @if (Model.User.PremiumExpiryDate.Value > DateTime.Now)
                            {
                                <span class="badge bg-success">Premium đến @Model.User.PremiumExpiryDate.Value.ToString("dd/MM/yyyy")</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Premium đã hết hạn</span>
                            }
                        }
                        else
                        {
                            <span class="badge bg-light text-dark">Tài khoản thường</span>
                        }
                    </div>
                    <div>
                        <a href="@Url.Action("UserDetails", "Admin", new { id = Model.UserId })" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>Xem chi tiết
                        </a>
                    </div>
                </div>
            </div>            <!-- Processing History -->
            @if (Model.ApprovalDate.HasValue)
            {
                <div class="admin-form-section mb-4">
                    <h5><i class="fas fa-history me-2"></i>Lịch sử xử lý</h5>
                    <div class="alert alert-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Xử lý bởi:</strong> Admin<br>
                                <strong>Thời gian:</strong> @Model.ApprovalDate.Value.ToString("dd/MM/yyyy HH:mm")<br>
                                @if (!string.IsNullOrEmpty(Model.AdminComment))
                                {
                                    <strong>Ghi chú:</strong> @Model.AdminComment
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Payment Proof and Actions -->
        <div class="col-lg-4">            <!-- Payment Proof -->
            @if (!string.IsNullOrEmpty(Model.ProofImageUrl))
            {
                <div class="admin-form-section mb-4">
                    <h5><i class="fas fa-image me-2"></i>Minh chứng thanh toán</h5>
                    <div class="text-center">
                        <img src="~/uploads/payment-proofs/@Model.ProofImageUrl" 
                             alt="Minh chứng thanh toán" 
                             class="img-fluid rounded cursor-pointer"
                             style="max-height: 300px; cursor: pointer;"
                             data-bs-toggle="modal" 
                             data-bs-target="#proofModal" />
                        <div class="mt-2">
                            <a href="~/uploads/payment-proofs/@Model.ProofImageUrl" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i>Mở trong tab mới
                            </a>
                        </div>
                    </div>
                </div>
            }            <!-- Processing Actions -->
            @if (Model.Status == 2) // Pending
            {                
                <div class="admin-form-section">
                    <h5><i class="fas fa-cogs me-2"></i>Xử lý yêu cầu</h5>
                    <form method="post" action="@Url.Action("ProcessPremiumRequest", "Admin")">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        
                        <div class="mb-3">
                            <label class="form-label">Ghi chú admin (tùy chọn)</label>
                            <textarea name="adminNotes" class="form-control" rows="3" placeholder="Thêm ghi chú về quyết định của bạn..."></textarea>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="Approved" class="btn btn-success" onclick="return confirm('Bạn có chắc chắn muốn duyệt yêu cầu này?')">
                                <i class="fas fa-check me-2"></i>Duyệt yêu cầu
                            </button>
                            <button type="submit" name="action" value="Rejected" class="btn btn-danger" onclick="return confirm('Bạn có chắc chắn muốn từ chối yêu cầu này?')">
                                <i class="fas fa-times me-2"></i>Từ chối yêu cầu
                            </button>
                        </div>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for viewing payment proof -->
<div class="modal fade" id="proofModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Minh chứng thanh toán - Yêu cầu #@Model.Id</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>            <div class="modal-body text-center">
                <img src="~/uploads/payment-proofs/@Model.ProofImageUrl" 
                     alt="Minh chứng thanh toán" 
                     class="img-fluid rounded" />
            </div>
        </div>
    </div>
</div>
