@model crackhub.Models.Data.Game
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = $"{Model.Title} - CrackHub";
    bool isLoggedIn = HttpContextAccessor.HttpContext.Session.GetString("UserId") != null;
    bool isFavorite = ViewBag.IsFavorite == true;
}

<div class="container game-details-container">
    <!-- Game Header -->
    <div class="row gx-lg-5">
        <div class="col-md-4">
            <div class="game-cover-wrapper">
                <img src="@Model.CoverImageUrl" class="game-cover-img" alt="@Model.Title" onerror="this.src='/img/no-image.jpg'" />
                <div class="game-cover-overlay">
                    <a href="@Url.Action("Download", "Game", new { id = Model.Id })" class="cover-download-btn">
                        <i class="fas fa-download me-2"></i> Tải game
                    </a>
                </div>
            </div>
            
            <div class="d-grid gap-3 mb-4">
                <a href="@Url.Action("Download", "Game", new { id = Model.Id })" class="btn btn-lg download-btn">
                    <i class="fas fa-download me-2"></i> Tải game
                </a>
                
                @if (isLoggedIn) 
                {
                    <button class="btn btn-lg favorite-btn @(isFavorite ? "active" : "")" data-game-id="@Model.Id" data-type="text">
                        <i class="@(isFavorite ? "fas" : "far") fa-heart me-2"></i> @(isFavorite ? "Bỏ yêu thích" : "Yêu thích")
                    </button>
                }
                else
                {
                    <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="btn btn-lg favorite-btn">
                        <i class="far fa-heart me-2"></i> Yêu thích
                    </a>
                }
            </div>
            
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-info-circle me-2"></i> Thông tin
                </div>
                <div class="card-body p-0">
                    <table class="table info-table">
                        <tbody>
                            <tr>
                                <td>Nhà phát triển</td>
                                <td>@Model.Developer</td>
                            </tr>
                            <tr>
                                <td>Nhà phát hành</td>
                                <td>@Model.Publisher</td>
                            </tr>
                            <tr>
                                <td>Ngày phát hành</td>
                                <td>@(Model.ReleaseDate?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                            </tr>
                            <tr>
                                <td>Thể loại</td>
                                <td>
                                    <a href="@Url.Action("ByCategory", "Game", new { categorySlug = Model.Category?.Slug })" class="category-link">
                                        @Model.Category?.CategoryName
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td>Dung lượng</td>
                                <td>@Model.Size</td>
                            </tr>
                            <tr>
                                <td>Lượt tải</td>
                                <td>@Model.Downloads.ToString()</td>
                            </tr>
                            <tr>
                                <td>Đánh giá</td>
                                <td>
                                    <div class="rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="@(i <= Math.Round(Model.AverageRating / 2) ? "fas" : "far") fa-star"></i>
                                        }
                                    </div>
                                    <span class="ms-2 fw-bold">@Model.AverageRating.ToString("0.0")/10</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <h1 class="game-title">@Model.Title</h1>
            
            <div class="game-tags">
                @if (Model.GameTags != null && Model.GameTags.Any())
                {
                    foreach (var gameTag in Model.GameTags)
                    {
                        <a href="@Url.Action("Tag", "Game", new { id = gameTag.TagId })" class="game-tag">@gameTag.Tag?.Name</a>
                    }
                }
            </div>
            
            <div class="short-description">
                <p class="lead mb-0">@Model.ShortDescription</p>
            </div>
            
            <div class="full-description">
                <h3 class="section-header"><i class="fas fa-info-circle me-2"></i>Giới thiệu</h3>
                <div class="card content-card">
                    <div class="card-body">
                        @Html.Raw(Model.FullDescription?.Replace("\n", "<br />"))
                    </div>
                </div>
            </div>
            
            <!-- Screenshots Gallery -->
            <div class="screenshots">
                <h3 class="section-header"><i class="fas fa-images me-2"></i>Hình ảnh</h3>
                <div class="row g-3">
                    @if (Model.Screenshots != null && Model.Screenshots.Any())
                    {
                        foreach (var screenshot in Model.Screenshots)
                        {
                            <div class="col-md-4 col-6">
                                <a href="@screenshot.ImageUrl" data-fancybox="gallery" class="screenshot-item">
                                    <img src="@screenshot.ImageUrl" class="img-fluid" alt="Screenshot" onerror="this.src='/img/no-image.jpg'" />
                                    <div class="screenshot-overlay">
                                        <span class="zoom-icon"><i class="fas fa-search-plus"></i></span>
                                    </div>
                                </a>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col">
                            <div class="alert alert-light">
                                <p class="mb-0"><i class="fas fa-info-circle me-2"></i>Chưa có hình ảnh nào cho game này.</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Features -->
            @if (Model.Features != null && Model.Features.Any())
            {
                <div class="features">
                    <h3 class="section-header"><i class="fas fa-star me-2"></i>Tính năng</h3>
                    <div class="feature-list">
                        @foreach (var feature in Model.Features)
                        {
                            <div class="feature-item">
                                <i class="fas fa-check-circle feature-icon"></i>
                                <span>@feature.FeatureDescription</span>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- System Requirements -->
            @if (Model.SystemRequirements != null && Model.SystemRequirements.Any())
            {
                <div class="system-requirements">
                    <h3 class="section-header"><i class="fas fa-microchip me-2"></i>Cấu hình yêu cầu</h3>
                    
                    <div class="row">
                        @{
                            var minReqs = Model.SystemRequirements.FirstOrDefault(sr => sr.RequirementType == "Minimum");
                            var recReqs = Model.SystemRequirements.FirstOrDefault(sr => sr.RequirementType == "Recommended");
                        }
                        
                        @if (minReqs != null)
                        {
                            <div class="col-md-6">
                                <div class="requirements-card">
                                    <div class="requirements-header bg-secondary text-white">
                                        <i class="fas fa-microchip me-2"></i> Cấu hình tối thiểu
                                    </div>
                                    <div class="requirements-body">
                                        <ul class="requirements-list list-unstyled">
                                            <li><strong>Hệ điều hành:</strong> @minReqs.OS</li>
                                            <li><strong>CPU:</strong> @minReqs.Processor</li>
                                            <li><strong>RAM:</strong> @minReqs.Memory</li>
                                            <li><strong>GPU:</strong> @minReqs.Graphics</li>
                                            <li><strong>DirectX:</strong> @minReqs.DirectX</li>
                                            <li><strong>Dung lượng:</strong> @minReqs.Storage</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        @if (recReqs != null)
                        {
                            <div class="col-md-6">
                                <div class="requirements-card">
                                    <div class="requirements-header bg-primary text-white">
                                        <i class="fas fa-microchip me-2"></i> Cấu hình đề xuất
                                    </div>
                                    <div class="requirements-body">
                                        <ul class="requirements-list list-unstyled">
                                            <li><strong>Hệ điều hành:</strong> @recReqs.OS</li>
                                            <li><strong>CPU:</strong> @recReqs.Processor</li>
                                            <li><strong>RAM:</strong> @recReqs.Memory</li>
                                            <li><strong>GPU:</strong> @recReqs.Graphics</li>
                                            <li><strong>DirectX:</strong> @recReqs.DirectX</li>
                                            <li><strong>Dung lượng:</strong> @recReqs.Storage</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- Crack Info -->
            @if (Model.CrackInfos != null && Model.CrackInfos.Any())
            {
                <div class="crack-info">
                    <h3 class="section-header"><i class="fas fa-unlock-alt me-2"></i>Thông tin crack</h3>
                    
                    <div class="accordion" id="crackAccordion">
                        @foreach (var crackInfo in Model.CrackInfos)
                        {
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="crack-heading-@crackInfo.Id">
                                    <button class="accordion-button @(crackInfo.IsRecommended ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#crack-collapse-@crackInfo.Id" aria-expanded="@(crackInfo.IsRecommended ? "true" : "false")" aria-controls="crack-collapse-@crackInfo.Id">
                                        <div>
                                            <strong>@crackInfo.Group</strong> - Phiên bản @crackInfo.Version
                                            @if(crackInfo.IsRecommended)
                                            {
                                                <span class="badge bg-success ms-2">Khuyên dùng</span>
                                            }
                                        </div>
                                    </button>
                                </h2>
                                <div id="crack-collapse-@crackInfo.Id" class="accordion-collapse collapse @(crackInfo.IsRecommended ? "show" : "")" aria-labelledby="crack-heading-@crackInfo.Id" data-bs-parent="#crackAccordion">
                                    <div class="accordion-body">
                                        <p>@crackInfo.Description</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong><i class="far fa-calendar-alt me-2"></i>Ngày phát hành:</strong> @crackInfo.ReleaseDate?.ToString("dd/MM/yyyy")</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong><i class="fas fa-file-archive me-2"></i>Dung lượng:</strong> @crackInfo.FileSize</p>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <a href="@Url.Action("Download", "Game", new { id = Model.Id, crackId = crackInfo.Id })" class="btn btn-primary px-4">
                                                <i class="fas fa-download me-2"></i> Tải xuống
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- Related Games -->
            @if (ViewBag.RelatedGames != null && ((IEnumerable<crackhub.Models.Data.Game>)ViewBag.RelatedGames).Any())
            {
                <div class="related-games">
                    <h3 class="section-header"><i class="fas fa-gamepad me-2"></i>Game tương tự</h3>
                    <div class="row">
                        @foreach (var relGame in (IEnumerable<crackhub.Models.Data.Game>)ViewBag.RelatedGames)
                        {
                            <div class="col-md-3 col-6 mb-3">
                                <div class="related-game-card h-100">
                                    <img src="@relGame.CoverImageUrl" class="card-img-top" alt="@relGame.Title" onerror="this.src='/img/no-image.jpg'" />
                                    <div class="card-body p-2">
                                        <h6 class="related-game-title">
                                            <a href="@Url.Action("Details", "Game", new { id = relGame.Id })" class="related-game-link">
                                                @relGame.Title
                                            </a>
                                        </h6>
                                        <div class="small">
                                            <div class="rating">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="@(i <= Math.Round(relGame.AverageRating / 2) ? "fas" : "far") fa-star fa-xs"></i>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- Reviews Section -->
            <div class="reviews">
                <h3 class="section-header"><i class="fas fa-comment-alt me-2"></i>Đánh giá từ người dùng</h3>
                
                @if (isLoggedIn)
                {
                    <div class="review-form-card mb-4">
                        <div class="review-form-header">
                            <i class="fas fa-comment me-2"></i>
                            Đánh giá của bạn
                        </div>
                        <div class="review-form-body">
                            <form id="reviewForm">
                                <input type="hidden" id="gameId" value="@Model.Id" />
                                
                                <div class="mb-4">
                                    <label for="rating" class="form-label">Điểm đánh giá</label>
                                    <div class="rating-selector">
                                        <div class="stars-container">
                                            <div class="star-rating-selection">
                                                @for (int i = 5; i >= 1; i--)
                                                {
                                                    <input type="radio" id="rating-@i" name="rating" value="@i" @(i == 5 ? "checked" : "")>
                                                    <label for="rating-@i"><i class="fas fa-star"></i></label>
                                                }
                                            </div>
                                            <span id="rating-text" class="ms-2">Xuất sắc</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="reviewTitle" class="form-label">Tiêu đề</label>
                                    <input type="text" class="form-control form-control-lg" id="reviewTitle" name="title" placeholder="Nhập tiêu đề đánh giá..." required />
                                    <div class="invalid-feedback">Vui lòng nhập tiêu đề.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="reviewContent" class="form-label">Nội dung</label>
                                    <textarea class="form-control form-control-lg" id="reviewContent" name="content" rows="3" placeholder="Chia sẻ ý kiến của bạn..." required></textarea>
                                    <div class="invalid-feedback">Vui lòng nhập nội dung đánh giá.</div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="submit" class="btn submit-review-btn" id="submitReview">
                                        <i class="fas fa-paper-plane me-2"></i> Gửi đánh giá
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-4 login-alert">
                        <i class="fas fa-info-circle me-2"></i>
                        Bạn cần <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="alert-link">đăng nhập</a> để đánh giá game này.
                    </div>
                }
                
                <div id="reviewsList">
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        foreach (var review in Model.Reviews.OrderByDescending(r => r.DatePosted))
                        {
                            <div class="review-card">
                                <div class="review-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="@(review.User?.AvatarUrl ?? "/img/default-avatar.png")" alt="@review.User?.DisplayName" class="rounded-circle me-2" width="40" height="40">
                                        <div>
                                            <strong>@review.User?.DisplayName</strong>
                                            <div class="rating d-block mt-1">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="@(i <= review.Rating ? "fas" : "far") fa-star"></i>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">@review.DatePosted.ToString("dd/MM/yyyy")</small>
                                </div>
                                <div class="review-body">
                                    <h5 class="review-title">@review.Title</h5>
                                    <p class="mb-0">@review.Content</p>
                                </div>
                                <div class="review-footer text-end">
                                    <button class="btn btn-sm helpful-btn" data-review-id="@review.Id">
                                        <i class="fas fa-thumbs-up me-1"></i>
                                        Hữu ích (@review.HelpfulCount)
                                    </button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-light empty-state">
                            <div class="text-center py-4">
                                <i class="far fa-comment-dots fa-3x mb-3 text-muted"></i>
                                <p class="mb-0">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá game này!</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Prevent duplicate authentication alerts by checking if we're logged in
            var isLoggedIn = @Json.Serialize(isLoggedIn);
            
            // Initialize Fancybox for screenshots
            if (typeof $.fancybox !== 'undefined') {
                $('[data-fancybox]').fancybox({
                    buttons: [
                        "zoom",
                        "slideShow",
                        "fullScreen",
                        "download",
                        "close"
                    ],
                    loop: true,
                    animationEffect: "zoom",
                    transitionEffect: "slide"
                });
            }
            
            // Rating text update based on selected stars
            function updateRatingText(rating) {
                var ratingTexts = {
                    1: "Rất tệ",
                    2: "Không tốt",
                    3: "Bình thường",
                    4: "Tốt",
                    5: "Xuất sắc"
                };
                $("#rating-text").text(ratingTexts[rating]);
            }
            
            // Initialize with default rating (5 stars)
            updateRatingText(5);
            
            // Update rating text when user selects a different rating
            $("input[name='rating']").change(function() {
                var selectedRating = $(this).val();
                updateRatingText(selectedRating);
            });
            
            // Form validation
            function validateForm() {
                var isValid = true;
                var title = $("#reviewTitle").val();
                var content = $("#reviewContent").val();
                
                if (!title) {
                    $("#reviewTitle").addClass("is-invalid");
                    isValid = false;
                } else {
                    $("#reviewTitle").removeClass("is-invalid");
                }
                
                if (!content) {
                    $("#reviewContent").addClass("is-invalid");
                    isValid = false;
                } else {
                    $("#reviewContent").removeClass("is-invalid");
                }
                
                return isValid;
            }
            
            // Handle review form submission
            $("#reviewForm").submit(function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return false;
                }
                
                var gameId = $("#gameId").val();
                var title = $("#reviewTitle").val();
                var content = $("#reviewContent").val();
                var rating = $("input[name='rating']:checked").val();
                
                // Show loading state
                $("#submitReview").html('<i class="fas fa-spinner fa-spin me-1"></i> Đang gửi...');
                $("#submitReview").prop('disabled', true);
                
                $.ajax({
                    url: '@Url.Action("AddReview", "Game")',
                    type: 'POST',
                    data: {
                        gameId: gameId,
                        title: title,
                        content: content,
                        rating: rating
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            if (typeof toastr !== 'undefined') {
                                toastr.success(response.message);
                            } else {
                                alert(response.message);
                            }
                            
                            // Reset form
                            $("#reviewForm")[0].reset();
                            
                            // Reset button state
                            $("#submitReview").html('<i class="fas fa-paper-plane me-1"></i> Gửi đánh giá');
                            $("#submitReview").prop('disabled', false);
                            
                            // Reload page to show new review
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            // Don't show error messages if we're already logged in
                            if (isLoggedIn && response.message.includes("đăng nhập")) {
                                // Skip showing the error and try to proceed
                                console.log("Ignoring redundant login message: " + response.message);
                                // Reset button state
                                $("#submitReview").html('<i class="fas fa-paper-plane me-1"></i> Gửi đánh giá');
                                $("#submitReview").prop('disabled', false);
                            } else {
                                // Show error message
                                if (typeof toastr !== 'undefined') {
                                    toastr.error(response.message);
                                } else {
                                    alert(response.message);
                                }
                                
                                // Reset button state
                                $("#submitReview").html('<i class="fas fa-paper-plane me-1"></i> Gửi đánh giá');
                                $("#submitReview").prop('disabled', false);
                            }
                        }
                    },
                    error: function() {
                        // Show error message
                        if (typeof toastr !== 'undefined') {
                            toastr.error("Đã xảy ra lỗi khi gửi đánh giá!");
                        } else {
                            alert("Đã xảy ra lỗi khi gửi đánh giá!");
                        }
                        
                        // Reset button state
                        $("#submitReview").html('<i class="fas fa-paper-plane me-1"></i> Gửi đánh giá');
                        $("#submitReview").prop('disabled', false);
                    }
                });
            });
            
            // Handle favorite button
            $(".favorite-btn").click(function() {
                var gameId = $(this).data('game-id');
                var $btn = $(this);
                
                $.ajax({
                    url: '@Url.Action("ToggleFavorite", "Game")',
                    type: 'POST',
                    data: {
                        gameId: gameId
                    },
                    success: function(response) {
                        if (response.success) {
                            if (response.isFavorite) {
                                $btn.html('<i class="fas fa-heart me-2"></i> Bỏ yêu thích');
                                $btn.addClass('active');
                                if (typeof toastr !== 'undefined') {
                                    toastr.success(response.message);
                                }
                            } else {
                                $btn.html('<i class="far fa-heart me-2"></i> Yêu thích');
                                $btn.removeClass('active');
                                if (typeof toastr !== 'undefined') {
                                    toastr.info(response.message);
                                }
                            }
                        } else {
                            // If user is not authenticated, redirect to login page with return URL
                            if (response.message.includes("đăng nhập")) {
                                if (typeof toastr !== 'undefined') {
                                    toastr.warning("Vui lòng đăng nhập để thêm game vào danh sách yêu thích!");
                                }
                                setTimeout(function() {
                                    window.location.href = '@Url.Action("Login", "Account")?returnUrl=' + encodeURIComponent(window.location.pathname);
                                }, 1500);
                            } else {
                                if (typeof toastr !== 'undefined') {
                                    toastr.error(response.message);
                                } else {
                                    alert(response.message);
                                }
                            }
                        }
                    },
                    error: function() {
                        if (typeof toastr !== 'undefined') {
                            toastr.error("Đã xảy ra lỗi khi thao tác với danh sách yêu thích!");
                        } else {
                            alert("Đã xảy ra lỗi khi thao tác với danh sách yêu thích!");
                        }
                    }
                });
            });
            
            // Handle helpful button for reviews
            $(".helpful-btn").click(function() {
                var $btn = $(this);
                var reviewId = $btn.data('review-id');
                
                // Show a loading indicator for a brief moment
                var originalText = $btn.html();
                $btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Đang xử lý...');
                
                // After a short delay, revert the button and show the message
                setTimeout(function() {
                    $btn.html(originalText);
                    
                    // Display the notification using toastr if available, otherwise use alert
                    if (typeof toastr !== 'undefined') {
                        toastr.info("Chức năng chưa phát triển :v", "Thông báo");
                    } else {
                        alert("Chức năng chưa phát triển :v");
                    }
                }, 500);
            });
            
            // Input validation on change
            $("#reviewTitle").on('input', function() {
                if ($(this).val()) {
                    $(this).removeClass("is-invalid");
                }
            });
            
            $("#reviewContent").on('input', function() {
                if ($(this).val()) {
                    $(this).removeClass("is-invalid");
                }
            });
            
            // Close any existing alerts that might be showing unnecessarily
            if (isLoggedIn) {
                $(".alert-info:contains('đăng nhập')").hide();
                // Also try to dismiss any browser alerts about logging in
                window.onbeforeunload = null;
                
                // This trick can sometimes prevent alerts from showing
                var oldAlert = window.alert;
                window.alert = function(message) {
                    if (message && message.indexOf && message.indexOf("đăng nhập") !== -1) {
                        console.log("Suppressed alert: " + message);
                        return;
                    }
                    oldAlert(message);
                };
            }
        });
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/game-details.css" />
}